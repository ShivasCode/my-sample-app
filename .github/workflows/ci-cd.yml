name: Harbor

on:
  push:
    branches: ["main"]

env:
  HARBOR_REGISTRY: test.harbor.legiontech.dev
  HARBOR_PROJECT: myproject
  KUBE_CONFIG: YXBpVmVyc2lvbjogdjENCmNsdXN0ZXJzOg0KLSBjbHVzdGVyOg0KICAgIGNlcnRpZmljYXRlLWF1dGhvcml0eS1kYXRhOiBMUzB0TFMxQ1JVZEpUaUJEUlZKVVNVWkpRMEZVUlMwdExTMHRDazFKU1VSQ1ZFTkRRV1V5WjBGM1NVSkJaMGxKWkd0aU9WTldXRk53YW5kM1JGRlpTa3R2V2tsb2RtTk9RVkZGVEVKUlFYZEdWRVZVVFVKRlIwRXhWVVVLUVhoTlMyRXpWbWxhV0VwMVdsaFNiR042UVdWR2R6QjVUbFJGZUUxRVRYZE5lbFUwVFdwQ1lVWjNNSHBPVkVWNFRVUkZkMDVFUVhwTmFrSmhUVUpWZUFwRmVrRlNRbWRPVmtKQlRWUkRiWFF4V1cxV2VXSnRWakJhV0UxM1oyZEZhVTFCTUVkRFUzRkhVMGxpTTBSUlJVSkJVVlZCUVRSSlFrUjNRWGRuWjBWTENrRnZTVUpCVVVSV04wTnRaeTh6WjNSck1ESXhaV1JKZDFSdFIyOWpNRFZ2T1VSVGRGcHFaak5FUlVSUloxQkdjWFpuZUhoTGNXOVhURGRQV2poVVIyRUtNMkpCUVRCMlJtZFFhM0pDY1RsdGEwTTJabFZ3T0Vsd1lVaDFZMmN3V2pKclNtTXZNVmg1ZEd4VFJGRmxTbVJ2SzJaWFUyVTFaa3BoVmt4WUwwOWhLd3B3YmsxdVRXUnNURE5xVGl0aGFYWjBaUzluY1drd1IyTnhaMDVuUzJSWGJIVTNiSFUwVnpoRWVuUklja1ZQVlZwRFQwMVhWMlpTTkdaNlRscHFZMDFuQ205NGFqaGFSa0pKYjA5SVFVSXpRelF5YkdWV2NFNDNOalJTY0RSTFlYZ3hOMVZ5WkRnMFVuTjFhbEIyZG1saFZqUkVXVU5xU2xGdk9TODVZblU0ZUVjS0syVllMME41VlZoUU4yTnBUVGRuVUUxVWVFbHdZbHBoZWt0b2Nsb3ZLMm8zYW5jeEszZFNXbFZEU1Rsa1RrbE5XREJHZVM5NWNuZElNMEZRV1ZwRVN3cHZkWEp0Ymt3dldVc3ZOME5CVnpoTE0ybDNZUzlNY2tRMFRGbDBRV2ROUWtGQlIycFhWRUpZVFVFMFIwRXhWV1JFZDBWQ0wzZFJSVUYzU1VOd1JFRlFDa0puVGxaSVVrMUNRV1k0UlVKVVFVUkJVVWd2VFVJd1IwRXhWV1JFWjFGWFFrSlVPSEZLVm5rdlowUnVjbUprVHpGQlRqZ3pMMk54YUdoT09GVnFRVllLUW1kT1ZraFNSVVZFYWtGTloyZHdjbVJYU214amJUVnNaRWRXZWsxQk1FZERVM0ZIVTBsaU0wUlJSVUpEZDFWQlFUUkpRa0ZSUW5aMmNXdFJlbkIyV0FvclNuTk5SM056ZDNsVFQzWk9OR2NyT0ZWSGNHUk1jR1JPYzFVcmRFdzFaMFJLZFZNMFdFSTFaVFZrYlZBNWRWZEdkQ3RqTW5aRk5FRjVMMUJhTWs4dkNsa3ZNM3BtV1RGeWQyRjZjekF4VjNwV1dGbENjMm81T1hwM09YaEhOV0ZMVlZWUmFGVk5VWHBTZDJKaFlYVXhVM2RYVW05c2J6RktkSFptUjJjMmJFSUtiMWhZWkV4eWNEUktLM0kzTDJKTlJFeEpUaTlzVUVkV016RmFSbGhLZFVwRUwwSndUVGRXT0ZsSGN6ZGxibWg2Vmt4UVRHOVRkWGwwVVRaWFprMHhSZ3AxTjNOall6Qk1jakpsZW5kM0wyaEZTeTl4ZUM5Skt6YzNORmRTU1cxQkt6VkxlR3RsZUhOWVJuVXhWRFY0UkV4TlZGY3hlRE5ITUdob1pVWmxRWGN2Q21oWGREaHZhbFZEUTFFMFRWQkVVVkZVUjNFeVYwSktiREZCUTBsQ1F6WktPRXBrTUZkTlpHeFRTalZrVjFCQ0x6ZzFValZsV0ZGVVR6RkRZbGRTWXpFS1MwdFVVREYwY1dJMU5saEJDaTB0TFMwdFJVNUVJRU5GVWxSSlJrbERRVlJGTFMwdExTMEsNCiAgICBzZXJ2ZXI6IGh0dHBzOi8vMkUyRUY1QzdGMDE4MUREOUZENzQxMkYzMkJGQjQwODcuZ3I3LmFwLXNvdXRoZWFzdC0xLmVrcy5hbWF6b25hd3MuY29tDQogIG5hbWU6IGFybjphd3M6ZWtzOmFwLXNvdXRoZWFzdC0xOjc2MjQxMjAxODExODpjbHVzdGVyL3NlY3VyZS1jbHVzdGVyDQotIGNsdXN0ZXI6DQogICAgY2VydGlmaWNhdGUtYXV0aG9yaXR5LWRhdGE6IExTMHRMUzFDUlVkSlRpQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENrMUpTVVJDVkVORFFXVXlaMEYzU1VKQlowbEpaR3RpT1ZOV1dGTndhbmQzUkZGWlNrdHZXa2xvZG1OT1FWRkZURUpSUVhkR1ZFVlVUVUpGUjBFeFZVVUtRWGhOUzJFelZtbGFXRXAxV2xoU2JHTjZRV1ZHZHpCNVRsUkZlRTFFVFhkTmVsVTBUV3BDWVVaM01IcE9WRVY0VFVSRmQwNUVRWHBOYWtKaFRVSlZlQXBGZWtGU1FtZE9Wa0pCVFZSRGJYUXhXVzFXZVdKdFZqQmFXRTEzWjJkRmFVMUJNRWREVTNGSFUwbGlNMFJSUlVKQlVWVkJRVFJKUWtSM1FYZG5aMFZMQ2tGdlNVSkJVVVJXTjBOdFp5OHpaM1JyTURJeFpXUkpkMVJ0UjI5ak1EVnZPVVJUZEZwcVpqTkVSVVJSWjFCR2NYWm5lSGhMY1c5WFREZFBXamhVUjJFS00ySkJRVEIyUm1kUWEzSkNjVGx0YTBNMlpsVndPRWx3WVVoMVkyY3dXakpyU21Ndk1WaDVkR3hUUkZGbFNtUnZLMlpYVTJVMVprcGhWa3hZTDA5aEt3cHdiazF1VFdSc1RETnFUaXRoYVhaMFpTOW5jV2t3UjJOeFowNW5TMlJYYkhVM2JIVTBWemhFZW5SSWNrVlBWVnBEVDAxWFYyWlNOR1o2VGxwcVkwMW5DbTk0YWpoYVJrSkpiMDlJUVVJelF6UXliR1ZXY0U0M05qUlNjRFJMWVhneE4xVnlaRGcwVW5OMWFsQjJkbWxoVmpSRVdVTnFTbEZ2T1M4NVluVTRlRWNLSzJWWUwwTjVWVmhRTjJOcFRUZG5VRTFVZUVsd1lscGhla3RvY2xvdksybzNhbmN4SzNkU1dsVkRTVGxrVGtsTldEQkdlUzk1Y25kSU0wRlFXVnBFU3dwdmRYSnRia3d2V1Vzdk4wTkJWemhMTTJsM1lTOU1ja1EwVEZsMFFXZE5Ra0ZCUjJwWFZFSllUVUUwUjBFeFZXUkVkMFZDTDNkUlJVRjNTVU53UkVGUUNrSm5UbFpJVWsxQ1FXWTRSVUpVUVVSQlVVZ3ZUVUl3UjBFeFZXUkVaMUZYUWtKVU9IRktWbmt2WjBSdWNtSmtUekZCVGpnekwyTnhhR2hPT0ZWcVFWWUtRbWRPVmtoU1JVVkVha0ZOWjJkd2NtUlhTbXhqYlRWc1pFZFdlazFCTUVkRFUzRkhVMGxpTTBSUlJVSkRkMVZCUVRSSlFrRlJRbloyY1d0UmVuQjJXQW9yU25OTlIzTnpkM2xUVDNaT05HY3JPRlZIY0dSTWNHUk9jMVVyZEV3MVowUktkVk0wV0VJMVpUVmtiVkE1ZFZkR2RDdGpNblpGTkVGNUwxQmFNazh2Q2xrdk0zcG1XVEZ5ZDJGNmN6QXhWM3BXV0ZsQ2MybzVPWHAzT1hoSE5XRkxWVlZSYUZWTlVYcFNkMkpoWVhVeFUzZFhVbTlzYnpGS2RIWm1SMmMyYkVJS2IxaFlaRXh5Y0RSS0szSTNMMkpOUkV4SlRpOXNVRWRXTXpGYVJsaEtkVXBFTDBKd1RUZFdPRmxIY3pkbGJtaDZWa3hRVEc5VGRYbDBVVFpYWmsweFJncDFOM05qWXpCTWNqSmxlbmQzTDJoRlN5OXhlQzlKS3pjM05GZFNTVzFCS3pWTGVHdGxlSE5ZUm5VeFZEVjRSRXhOVkZjeGVETkhNR2hvWlVabFFYY3ZDbWhYZERodmFsVkRRMUUwVFZCRVVWRlVSM0V5VjBKS2JERkJRMGxDUXpaS09FcGtNRmROWkd4VFNqVmtWMUJDTHpnMVVqVmxXRkZVVHpGRFlsZFNZekVLUzB0VVVERjBjV0kxTmxoQkNpMHRMUzB0UlU1RUlFTkZVbFJKUmtsRFFWUkZMUzB0TFMwSw0KICAgIHNlcnZlcjogaHR0cHM6Ly8yRTJFRjVDN0YwMTgxREQ5RkQ3NDEyRjMyQkZCNDA4Ny5ncjcuYXAtc291dGhlYXN0LTEuZWtzLmFtYXpvbmF3cy5jb20NCiAgbmFtZTogc2VjdXJlLWNsdXN0ZXIuYXAtc291dGhlYXN0LTEuZWtzY3RsLmlvDQotIGNsdXN0ZXI6DQogICAgY2VydGlmaWNhdGUtYXV0aG9yaXR5LWRhdGE6IExTMHRMUzFDUlVkSlRpQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENrMUpTVVJDVkVORFFXVXlaMEYzU1VKQlowbEpTM0JxYzNKWVFXaFVMMVYzUkZGWlNrdHZXa2xvZG1OT1FWRkZURUpSUVhkR1ZFVlVUVUpGUjBFeFZVVUtRWGhOUzJFelZtbGFXRXAxV2xoU2JHTjZRV1ZHZHpCNVRsUkZlRTFFV1hoT1JGRXpUVlJDWVVaM01IcE9WRVY0VFVSUmVFNUVWWGxOVkVKaFRVSlZlQXBGZWtGU1FtZE9Wa0pCVFZSRGJYUXhXVzFXZVdKdFZqQmFXRTEzWjJkRmFVMUJNRWREVTNGSFUwbGlNMFJSUlVKQlVWVkJRVFJKUWtSM1FYZG5aMFZMQ2tGdlNVSkJVVVI1Y0ZkVE5IWmhWVzVzVjNVeGVFdHZlbXB1YkRNMmRURkxUekZuYldsNlkwOUdjM2RuTm5sUlJubE1hVXh2SzA1cFpVNVRTRVJwUzNrS09VbG1hbEY1WTBOMlJXODFiRk5RYjBKRU9YZHRkMWt3ZUhOTmFYVk1ORXRETVUxclNIQlVTMkZsTVRndlZDOVRWbEZKUkZKVmFtTldOM1p5VVU5Q2NRcHpOVTlJY1ZVMU5HRkZVR1p6UkRKTldGazBTVWcwWVVGWFIwUmtNVlZwSzJSUFprd3lORmRMVkhJclUzQmhNVTV5ZW1SaFFuWTJhbGR3ZEZsRE1tSnZDbk5RZFhkRFEwVnBXamszZUdoelpHczNXa2wzWTNKalNtMDVOMHM0ZDJSR01XWnFXR0p5UWtwSVpuUkpUa1V5WVVWSVNFUnFiSGR2VVRkRlJsRlJVbTBLUTJZdk9EUTBZa0kzVVhWeVEyTk1ka2RzUVU5TFJpdFNRMjV1YVhka01GbEpkR1JPVFZGa05EZ3dkVUZ1TVcwdkwyUm9kbVUwYnpBeFdWQlJjV3BGWVFweVFuQnFVR013THpoc1V6RTNkR293VTBGNGVGZzNhWFZJUkcxUVFXZE5Ra0ZCUjJwWFZFSllUVUUwUjBFeFZXUkVkMFZDTDNkUlJVRjNTVU53UkVGUUNrSm5UbFpJVWsxQ1FXWTRSVUpVUVVSQlVVZ3ZUVUl3UjBFeFZXUkVaMUZYUWtKUlkxaEpPVmw0YUVFNVdYWTVURXAzTlRGamRVWlhNbk5PTlVSNlFWWUtRbWRPVmtoU1JVVkVha0ZOWjJkd2NtUlhTbXhqYlRWc1pFZFdlazFCTUVkRFUzRkhVMGxpTTBSUlJVSkRkMVZCUVRSSlFrRlJRemhrUTIxaVUwSjVVUXBhUjFaQ1VYRnNiR0l5UjFGR1VtTkhVMjlaYjJGMFNHNWlkVWhaZUVOWVNHeFBaM1IzV0RkQlNrVlBlVzFNUW1ad1ZTOHphR3N6TldKSWIwZDZVek5GQ2psaWFDODVSMFpWTjJsVk0zVnpaVWx4UkdWVWVTOVpPVEZFVFVocFFtazVZVXRJWVU5RWFXRmFObTVHV0ZCMGJHWXJaemQ2WkRkTFJYQXdSekJhVVdjS1pWVTBaRnBzUVdkR1JYRnFaVkJrZEVWa2NEZDBURGhrWkVKbmNEZHVjRkJ0WlZobFpqTmhkSGMzUWxwRWEycDRVMGxKY2xaUFVIbzRlRnBTYWxjelR3cFhNR2xYWVhReVJWRmpSRGxGVEhNclkyaDJibWhuTVZJMk1WbEthVFEzUkRST1pUVkVPRnBvY0RGT1FWaFBiV1V2VUhGUWNYSlRXalJ4YkhWMGJITXhDa2xOVkRaYVlUWXZUbEV3Y0VWellUZzNibTl2SzBsaUsweEpUbEZxVG1SdWFuUjJNVlJ0TW1oR1JqSmxOazlETkZGTldXOWlRbkJ4V0N0NVNscFlWV1VLYkd0UE56TnllVGhHUmxGTENpMHRMUzB0UlU1RUlFTkZVbFJKUmtsRFFWUkZMUzB0TFMwSw0KICAgIHNlcnZlcjogaHR0cHM6Ly8yM0E0Mzg5Njc4QzEzNTEyM0M5OEFGMkMyMDREQ0NCQS5ncjcudXMtd2VzdC0yLmVrcy5hbWF6b25hd3MuY29tDQogIG5hbWU6IHRlc3QtY2x1c3Rlci51cy13ZXN0LTIuZWtzY3RsLmlvDQotIGNsdXN0ZXI6DQogICAgY2VydGlmaWNhdGUtYXV0aG9yaXR5LWRhdGE6IExTMHRMUzFDUlVkSlRpQkRSVkpVU1VaSlEwRlVSUzB0TFMwdENrMUpTVVJDVkVORFFXVXlaMEYzU1VKQlowbEpTM0JxYzNKWVFXaFVMMVYzUkZGWlNrdHZXa2xvZG1OT1FWRkZURUpSUVhkR1ZFVlVUVUpGUjBFeFZVVUtRWGhOUzJFelZtbGFXRXAxV2xoU2JHTjZRV1ZHZHpCNVRsUkZlRTFFV1hoT1JGRXpUVlJDWVVaM01IcE9WRVY0VFVSUmVFNUVWWGxOVkVKaFRVSlZlQXBGZWtGU1FtZE9Wa0pCVFZSRGJYUXhXVzFXZVdKdFZqQmFXRTEzWjJkRmFVMUJNRWREVTNGSFUwbGlNMFJSUlVKQlVWVkJRVFJKUWtSM1FYZG5aMFZMQ2tGdlNVSkJVVVI1Y0ZkVE5IWmhWVzVzVjNVeGVFdHZlbXB1YkRNMmRURkxUekZuYldsNlkwOUdjM2RuTm5sUlJubE1hVXh2SzA1cFpVNVRTRVJwUzNrS09VbG1hbEY1WTBOMlJXODFiRk5RYjBKRU9YZHRkMWt3ZUhOTmFYVk1ORXRETVUxclNIQlVTMkZsTVRndlZDOVRWbEZKUkZKVmFtTldOM1p5VVU5Q2NRcHpOVTlJY1ZVMU5HRkZVR1p6UkRKTldGazBTVWcwWVVGWFIwUmtNVlZwSzJSUFprd3lORmRMVkhJclUzQmhNVTV5ZW1SaFFuWTJhbGR3ZEZsRE1tSnZDbk5RZFhkRFEwVnBXamszZUdoelpHczNXa2wzWTNKalNtMDVOMHM0ZDJSR01XWnFXR0p5UWtwSVpuUkpUa1V5WVVWSVNFUnFiSGR2VVRkRlJsRlJVbTBLUTJZdk9EUTBZa0kzVVhWeVEyTk1ka2RzUVU5TFJpdFNRMjV1YVhka01GbEpkR1JPVFZGa05EZ3dkVUZ1TVcwdkwyUm9kbVUwYnpBeFdWQlJjV3BGWVFweVFuQnFVR013THpoc1V6RTNkR293VTBGNGVGZzNhWFZJUkcxUVFXZE5Ra0ZCUjJwWFZFSllUVUUwUjBFeFZXUkVkMFZDTDNkUlJVRjNTVU53UkVGUUNrSm5UbFpJVWsxQ1FXWTRSVUpVUVVSQlVVZ3ZUVUl3UjBFeFZXUkVaMUZYUWtKUlkxaEpPVmw0YUVFNVdYWTVURXAzTlRGamRVWlhNbk5PTlVSNlFWWUtRbWRPVmtoU1JVVkVha0ZOWjJkd2NtUlhTbXhqYlRWc1pFZFdlazFCTUVkRFUzRkhVMGxpTTBSUlJVSkRkMVZCUVRSSlFrRlJRemhrUTIxaVUwSjVVUXBhUjFaQ1VYRnNiR0l5UjFGR1VtTkhVMjlaYjJGMFNHNWlkVWhaZUVOWVNHeFBaM1IzV0RkQlNrVlBlVzFNUW1ad1ZTOHphR3N6TldKSWIwZDZVek5GQ2psaWFDODVSMFpWTjJsVk0zVnpaVWx4UkdWVWVTOVpPVEZFVFVocFFtazVZVXRJWVU5RWFXRmFObTVHV0ZCMGJHWXJaemQ2WkRkTFJYQXdSekJhVVdjS1pWVTBaRnBzUVdkR1JYRnFaVkJrZEVWa2NEZDBURGhrWkVKbmNEZHVjRkJ0WlZobFpqTmhkSGMzUWxwRWEycDRVMGxKY2xaUFVIbzRlRnBTYWxjelR3cFhNR2xYWVhReVJWRmpSRGxGVEhNclkyaDJibWhuTVZJMk1WbEthVFEzUkRST1pUVkVPRnBvY0RGT1FWaFBiV1V2VUhGUWNYSlRXalJ4YkhWMGJITXhDa2xOVkRaYVlUWXZUbEV3Y0VWellUZzNibTl2SzBsaUsweEpUbEZxVG1SdWFuUjJNVlJ0TW1oR1JqSmxOazlETkZGTldXOWlRbkJ4V0N0NVNscFlWV1VLYkd0UE56TnllVGhHUmxGTENpMHRMUzB0UlU1RUlFTkZVbFJKUmtsRFFWUkZMUzB0TFMwSw0KICAgIHNlcnZlcjogaHR0cHM6Ly8yM0E0Mzg5Njc4QzEzNTEyM0M5OEFGMkMyMDREQ0NCQS5ncjcudXMtd2VzdC0yLmVrcy5hbWF6b25hd3MuY29tDQogIG5hbWU6IGFybjphd3M6ZWtzOnVzLXdlc3QtMjo3NjI0MTIwMTgxMTg6Y2x1c3Rlci90ZXN0LWNsdXN0ZXINCi0gY2x1c3RlcjoNCiAgICBjZXJ0aWZpY2F0ZS1hdXRob3JpdHktZGF0YTogTFMwdExTMUNSVWRKVGlCRFJWSlVTVVpKUTBGVVJTMHRMUzB0Q2sxSlNVUkNWRU5EUVdVeVowRjNTVUpCWjBsSlkybDBjVmx1ZDNGMmRUUjNSRkZaU2t0dldrbG9kbU5PUVZGRlRFSlJRWGRHVkVWVVRVSkZSMEV4VlVVS1FYaE5TMkV6Vm1sYVdFcDFXbGhTYkdONlFXVkdkekI1VGxSRmVFMUVZM2RPVkVGM1RXcE9ZVVozTUhwT1ZFVjRUVVJWZDA1VVFURk5hazVoVFVKVmVBcEZla0ZTUW1kT1ZrSkJUVlJEYlhReFdXMVdlV0p0VmpCYVdFMTNaMmRGYVUxQk1FZERVM0ZIVTBsaU0wUlJSVUpCVVZWQlFUUkpRa1IzUVhkblowVkxDa0Z2U1VKQlVVTjBVWEpPVjFOYUt6UTNaV3BtSzFCeVVVVnRXRmcxZVhaV05tUndVVlJqYlhsWVNubENUemhLWm14Wk9FRXdWbXBwVld4aFEwMHZaRllLVTA1RU5GaDRhVVJTUTNSaVIwRnplbmsyZEV4WVZFMHdkV1J1TkcxQk1XbHBjekZQWVhGTVdYVmhWRUZsVVhVM0wwbFdkVU5wWW1sUWExbDFka2xSV2dwSGJVdEVlbVZEVUd0TVMzUkdaaTlSTmtaeVZGVllWbTVZY1Zwck0zZEtPVmR1WlhKRE1HeG9RbW8zTVVKa2FtMUNVMW93U21KMFFVSjNOM0JKTDBKWENraGtkRFJUZVZOSk0xVjZhR1JUV0UwNWVteEtPR1U1YlZONWFEYzVPVk5HTVZVM1ZEaG1WM1V6YW1wc0wwMW9Sbk5WTmtod2QwbHNRV1ZHU1dwbWJpOEtTbFpEV0hKaFoySkpUWFpEWWxOMk9FRXJiRlp4ZVdwQ2FEa3ljWFpwUzJOT1Fsb3plRXhrT0dremFUZE9VbnBLVTFkR1puQTRWVThyWlc5QlZYTkdiUXBqU0M4NWNFdDNNWGh0Wm10dVdFRkdMM2h6TDAxTk4ybFJZMHBDUVdkTlFrRkJSMnBYVkVKWVRVRTBSMEV4VldSRWQwVkNMM2RSUlVGM1NVTndSRUZRQ2tKblRsWklVazFDUVdZNFJVSlVRVVJCVVVndlRVSXdSMEV4VldSRVoxRlhRa0pSTlhWR0wyRnVSMEZNYVRkRllVOWFOWFJaY1V0d2RYTTJNMFJVUVZZS1FtZE9Wa2hTUlVWRWFrRk5aMmR3Y21SWFNteGpiVFZzWkVkV2VrMUJNRWREVTNGSFUwbGlNMFJSUlVKRGQxVkJRVFJKUWtGUlEyOUlWMFE0TkVOTVJ3b3hWWEpaT0hGcFNXYzBhRUZWWkVZcldFaG5TRlF3WnpCUk9FdHdSbTlRUnpsd1QyTkVhRXhHUzFGNmVreDFZbVpDU0Zsck5EVlNPR1kzZEdkYU1teFRDako0UlZCYU5taFliMUpuY0dwblJGbFhVbEJMT0V0UVdXOHhXa2xFUm1sTmNXZHBMMmw0V214SWFUYzFaMlJYYkdwV0wxZzFVV0pGUkRWVmIzTkpiR1FLYWxkMk5VeEVNR0pJZUhneWVEVllhakpUUlhOb1IxWlFiRTU0ZEUxU09IcDFTbEV4TTJndlVYWnZWa3BwVURWTGNITTBNM2x1TW5ocFIwRk1VMUJ5YXdwb1pVRmlNR1JhUldWeFFVdEpURGhrWmxkck5ESTBla0V5TDJGQlRETlpNbVpKTVhoRVRsVmliblptTUVkWmNtcG9VMnhQWmxkMlNtVkljamg2ZHprdkNtVkVjamxPVGsxUVdHZFJiRXhaYzBkMU9ETjNVbTl5WjBRd1RXVkJjamxtVUhoclYxRkdWMGRIWnpGcVJUZG5VVk5hYUhaa04yTXlUa3h2VDBvNWFFSUtXVUZTYUUxaldXSlBTakphQ2kwdExTMHRSVTVFSUVORlVsUkpSa2xEUVZSRkxTMHRMUzBLDQogICAgc2VydmVyOiBodHRwczovL0I2QUMzRDYyQkMzQkIzNjg3MzNCOTdCMzkxNkFGNjA2LnNrMS51cy13ZXN0LTIuZWtzLmFtYXpvbmF3cy5jb20NCiAgbmFtZTogYXJuOmF3czpla3M6dXMtd2VzdC0yOjc2MjQxMjAxODExODpjbHVzdGVyL2VkdWNhdGlvbi1la3MtaEdmNVV4N2ENCi0gY2x1c3RlcjoNCiAgICBjZXJ0aWZpY2F0ZS1hdXRob3JpdHktZGF0YTogTFMwdExTMUNSVWRKVGlCRFJWSlVTVVpKUTBGVVJTMHRMUzB0Q2sxSlNVUkNWRU5EUVdVeVowRjNTVUpCWjBsSlIzaHZPVkoyV2s5TGNsbDNSRkZaU2t0dldrbG9kbU5PUVZGRlRFSlJRWGRHVkVWVVRVSkZSMEV4VlVVS1FYaE5TMkV6Vm1sYVdFcDFXbGhTYkdONlFXVkdkekI1VGxSRmVFMXFUWGhOYWtreFRXcENZVVozTUhwT1ZFVjRUV3BGZUUxcVRYZE5ha0poVFVKVmVBcEZla0ZTUW1kT1ZrSkJUVlJEYlhReFdXMVdlV0p0VmpCYVdFMTNaMmRGYVUxQk1FZERVM0ZIVTBsaU0wUlJSVUpCVVZWQlFUUkpRa1IzUVhkblowVkxDa0Z2U1VKQlVVUnZkbkIyU2poRGR6TmFabUp0ZURseFpWRlFWR1l5WjJrelVGWmhZek5zU1dkV2VuRlhaVGxCYW1kU2JGWlRMMk5FVkU1NlNsQk5OaThLTDJ3dk5IVnZiWGd6UjJGRVJVMHlNbGgyV2tJNGRqSjRZVmxNZDJoRlExb3JjV05LYldoMlRsTkJPWHB3ZW1sa2JUSnhaVXh0UzI1cVUzSmljbVZ1VWdwUmQxZzJPR3RvYldOaE1DdENWa3hDVGtSWFIxRmxXU3MwVUVjNGFrcEpPRXN6T0ZjcldsbHRaR2xsVDJZdk0yZHhXbEV5SzBKdWRWZzNSVFIyTWxONUNqRkhSV1p2UmtGWmFTdE5SbFJ2UVd4S2R6STFNRGcyU3pnd1RFMXNTamhDYWt0R1IxSk1NVGRWYXpKNlZqWm5RWGQxUTJoa1pHMU5NMUpRT1ZaSldUQUtPVmhwTVU0eVFYSnZjREJFTm1GWVYyUjRibGxzVWpOYVNYQk1NbVZ3WXpKb2VFUklRbTV4VkVzMlpYRnNNRkpYYVVkVlFrWmtkVTFpU1hWR05XZGtZUXBaYUhKNlVsRkdSa001WkRFeFIwVndObkY2VVcxUFRYRkxWRUkzUVdkTlFrRkJSMnBYVkVKWVRVRTBSMEV4VldSRWQwVkNMM2RSUlVGM1NVTndSRUZRQ2tKblRsWklVazFDUVdZNFJVSlVRVVJCVVVndlRVSXdSMEV4VldSRVoxRlhRa0pVVjI5amIybFRiR3BIVURkaFZuWmtXVm93YkZCME1UVlJhWFZFUVZZS1FtZE9Wa2hTUlVWRWFrRk5aMmR3Y21SWFNteGpiVFZzWkVkV2VrMUJNRWREVTNGSFUwbGlNMFJSUlVKRGQxVkJRVFJKUWtGUlFWQXJOR2xGVUZNMFNRcFNOM1J0WXpkdVRtRkxWalp3TVdkeWFHWkRZelFyWWxWVU5XSTROa3cyVTB4cmNrRkxhbkZIWVcxdVZVUTBOek00Y2pGMWExWlZhMGxzVEc1cVdWUnlDa1pKUzB3MFEwRnNlR2N5UnpaQmFETmtRWEkzWm5ocWMxZDBiMlV6UVZKSGJuUTFiSFJuVFVSVWExUk9URFl2Um14NFZXeHRMMGt6ZVVGM1lraDJiRTRLTDNCMlFVTlNkRFZGUlhaUVJYZ3Jia1IxVTJ3clZVeGhkMDVHYVZGa05FVnNRVEZZVVZaSFdrbGpTblZtZGtRclpHNHJlRVp5ZHpSSFpXNHhWa3hQS3dwdFdqVm9hMU16ZGtWV2QxTTVUVXhhU0d4MWMxUkNkMU54VjBkSWNHWnRWVGxWT0RkeU9VaEhPVzFTU25wM1dGcFJNMVl3WTAxSmVGY3pOemx5WldKeUNtdENZbmg2UlVoV1VYTkJVRTh5TDNvMVpqTjVlUzlsY25oYU9EQnlMMWRSYVZwNGJIQndRemR6U0M5UGJGWnhlazVDZVVwd2RVZDRSVUprZWxGc1pFY0tjSFJ3U3pZMVIwNHZZalZ1Q2kwdExTMHRSVTVFSUVORlVsUkpSa2xEUVZSRkxTMHRMUzBLDQogICAgc2VydmVyOiBodHRwczovLzkxMkZFNDJENkRGM0Y1RkFCNzRBNDk2ODZFMzc1RDBCLnNrMS51cy13ZXN0LTIuZWtzLmFtYXpvbmF3cy5jb20NCiAgbmFtZTogYXJuOmF3czpla3M6dXMtd2VzdC0yOjc2MjQxMjAxODExODpjbHVzdGVyL3N0YWdpbmctZGVtbw0KY29udGV4dHM6DQotIGNvbnRleHQ6DQogICAgY2x1c3RlcjogYXJuOmF3czpla3M6YXAtc291dGhlYXN0LTE6NzYyNDEyMDE4MTE4OmNsdXN0ZXIvc2VjdXJlLWNsdXN0ZXINCiAgICB1c2VyOiBhcm46YXdzOmVrczphcC1zb3V0aGVhc3QtMTo3NjI0MTIwMTgxMTg6Y2x1c3Rlci9zZWN1cmUtY2x1c3Rlcg0KICBuYW1lOiBhcm46YXdzOmVrczphcC1zb3V0aGVhc3QtMTo3NjI0MTIwMTgxMTg6Y2x1c3Rlci9zZWN1cmUtY2x1c3Rlcg0KLSBjb250ZXh0Og0KICAgIGNsdXN0ZXI6IHNlY3VyZS1jbHVzdGVyLmFwLXNvdXRoZWFzdC0xLmVrc2N0bC5pbw0KICAgIHVzZXI6IHNoaXZhQHNlY3VyZS1jbHVzdGVyLmFwLXNvdXRoZWFzdC0xLmVrc2N0bC5pbw0KICBuYW1lOiBzaGl2YUBzZWN1cmUtY2x1c3Rlci5hcC1zb3V0aGVhc3QtMS5la3NjdGwuaW8NCi0gY29udGV4dDoNCiAgICBjbHVzdGVyOiB0ZXN0LWNsdXN0ZXIudXMtd2VzdC0yLmVrc2N0bC5pbw0KICAgIHVzZXI6IHNoaXZhQHRlc3QtY2x1c3Rlci51cy13ZXN0LTIuZWtzY3RsLmlvDQogIG5hbWU6IHNoaXZhQHRlc3QtY2x1c3Rlci51cy13ZXN0LTIuZWtzY3RsLmlvDQotIGNvbnRleHQ6DQogICAgY2x1c3RlcjogYXJuOmF3czpla3M6dXMtd2VzdC0yOjc2MjQxMjAxODExODpjbHVzdGVyL3Rlc3QtY2x1c3Rlcg0KICAgIHVzZXI6IGFybjphd3M6ZWtzOnVzLXdlc3QtMjo3NjI0MTIwMTgxMTg6Y2x1c3Rlci90ZXN0LWNsdXN0ZXINCiAgbmFtZTogYXJuOmF3czpla3M6dXMtd2VzdC0yOjc2MjQxMjAxODExODpjbHVzdGVyL3Rlc3QtY2x1c3Rlcg0KLSBjb250ZXh0Og0KICAgIGNsdXN0ZXI6IGFybjphd3M6ZWtzOnVzLXdlc3QtMjo3NjI0MTIwMTgxMTg6Y2x1c3Rlci9lZHVjYXRpb24tZWtzLWhHZjVVeDdhDQogICAgdXNlcjogYXJuOmF3czpla3M6dXMtd2VzdC0yOjc2MjQxMjAxODExODpjbHVzdGVyL2VkdWNhdGlvbi1la3MtaEdmNVV4N2ENCiAgbmFtZTogYXJuOmF3czpla3M6dXMtd2VzdC0yOjc2MjQxMjAxODExODpjbHVzdGVyL2VkdWNhdGlvbi1la3MtaEdmNVV4N2ENCi0gY29udGV4dDoNCiAgICBjbHVzdGVyOiBhcm46YXdzOmVrczp1cy13ZXN0LTI6NzYyNDEyMDE4MTE4OmNsdXN0ZXIvc3RhZ2luZy1kZW1vDQogICAgdXNlcjogYXJuOmF3czpla3M6dXMtd2VzdC0yOjc2MjQxMjAxODExODpjbHVzdGVyL3N0YWdpbmctZGVtbw0KICBuYW1lOiBhcm46YXdzOmVrczp1cy13ZXN0LTI6NzYyNDEyMDE4MTE4OmNsdXN0ZXIvc3RhZ2luZy1kZW1vDQpjdXJyZW50LWNvbnRleHQ6IGFybjphd3M6ZWtzOnVzLXdlc3QtMjo3NjI0MTIwMTgxMTg6Y2x1c3Rlci9zdGFnaW5nLWRlbW8NCmtpbmQ6IENvbmZpZw0KdXNlcnM6DQotIG5hbWU6IGFybjphd3M6ZWtzOmFwLXNvdXRoZWFzdC0xOjc2MjQxMjAxODExODpjbHVzdGVyL3NlY3VyZS1jbHVzdGVyDQogIHVzZXI6DQogICAgZXhlYzoNCiAgICAgIGFwaVZlcnNpb246IGNsaWVudC5hdXRoZW50aWNhdGlvbi5rOHMuaW8vdjFiZXRhMQ0KICAgICAgYXJnczoNCiAgICAgIC0gLS1yZWdpb24NCiAgICAgIC0gYXAtc291dGhlYXN0LTENCiAgICAgIC0gZWtzDQogICAgICAtIGdldC10b2tlbg0KICAgICAgLSAtLWNsdXN0ZXItbmFtZQ0KICAgICAgLSBzZWN1cmUtY2x1c3Rlcg0KICAgICAgLSAtLW91dHB1dA0KICAgICAgLSBqc29uDQogICAgICBjb21tYW5kOiBhd3MNCiAgICAgIGVudjogbnVsbA0KICAgICAgaW50ZXJhY3RpdmVNb2RlOiBJZkF2YWlsYWJsZQ0KICAgICAgcHJvdmlkZUNsdXN0ZXJJbmZvOiBmYWxzZQ0KLSBuYW1lOiBzaGl2YUBzZWN1cmUtY2x1c3Rlci5hcC1zb3V0aGVhc3QtMS5la3NjdGwuaW8NCiAgdXNlcjoNCiAgICBleGVjOg0KICAgICAgYXBpVmVyc2lvbjogY2xpZW50LmF1dGhlbnRpY2F0aW9uLms4cy5pby92MWJldGExDQogICAgICBhcmdzOg0KICAgICAgLSBla3MNCiAgICAgIC0gZ2V0LXRva2VuDQogICAgICAtIC0tb3V0cHV0DQogICAgICAtIGpzb24NCiAgICAgIC0gLS1jbHVzdGVyLW5hbWUNCiAgICAgIC0gc2VjdXJlLWNsdXN0ZXINCiAgICAgIC0gLS1yZWdpb24NCiAgICAgIC0gYXAtc291dGhlYXN0LTENCiAgICAgIGNvbW1hbmQ6IGF3cw0KICAgICAgZW52Og0KICAgICAgLSBuYW1lOiBBV1NfU1RTX1JFR0lPTkFMX0VORFBPSU5UUw0KICAgICAgICB2YWx1ZTogcmVnaW9uYWwNCiAgICAgIGludGVyYWN0aXZlTW9kZTogSWZBdmFpbGFibGUNCiAgICAgIHByb3ZpZGVDbHVzdGVySW5mbzogZmFsc2UNCi0gbmFtZTogc2hpdmFAdGVzdC1jbHVzdGVyLnVzLXdlc3QtMi5la3NjdGwuaW8NCiAgdXNlcjoNCiAgICBleGVjOg0KICAgICAgYXBpVmVyc2lvbjogY2xpZW50LmF1dGhlbnRpY2F0aW9uLms4cy5pby92MWJldGExDQogICAgICBhcmdzOg0KICAgICAgLSBla3MNCiAgICAgIC0gZ2V0LXRva2VuDQogICAgICAtIC0tb3V0cHV0DQogICAgICAtIGpzb24NCiAgICAgIC0gLS1jbHVzdGVyLW5hbWUNCiAgICAgIC0gdGVzdC1jbHVzdGVyDQogICAgICAtIC0tcmVnaW9uDQogICAgICAtIHVzLXdlc3QtMg0KICAgICAgY29tbWFuZDogYXdzDQogICAgICBlbnY6DQogICAgICAtIG5hbWU6IEFXU19TVFNfUkVHSU9OQUxfRU5EUE9JTlRTDQogICAgICAgIHZhbHVlOiByZWdpb25hbA0KICAgICAgcHJvdmlkZUNsdXN0ZXJJbmZvOiBmYWxzZQ0KLSBuYW1lOiBhcm46YXdzOmVrczp1cy13ZXN0LTI6NzYyNDEyMDE4MTE4OmNsdXN0ZXIvdGVzdC1jbHVzdGVyDQogIHVzZXI6DQogICAgZXhlYzoNCiAgICAgIGFwaVZlcnNpb246IGNsaWVudC5hdXRoZW50aWNhdGlvbi5rOHMuaW8vdjFiZXRhMQ0KICAgICAgYXJnczoNCiAgICAgIC0gLS1yZWdpb24NCiAgICAgIC0gdXMtd2VzdC0yDQogICAgICAtIGVrcw0KICAgICAgLSBnZXQtdG9rZW4NCiAgICAgIC0gLS1jbHVzdGVyLW5hbWUNCiAgICAgIC0gdGVzdC1jbHVzdGVyDQogICAgICAtIC0tb3V0cHV0DQogICAgICAtIGpzb24NCiAgICAgIGNvbW1hbmQ6IGF3cw0KLSBuYW1lOiBhcm46YXdzOmVrczp1cy13ZXN0LTI6NzYyNDEyMDE4MTE4OmNsdXN0ZXIvZWR1Y2F0aW9uLWVrcy1oR2Y1VXg3YQ0KICB1c2VyOg0KICAgIGV4ZWM6DQogICAgICBhcGlWZXJzaW9uOiBjbGllbnQuYXV0aGVudGljYXRpb24uazhzLmlvL3YxYmV0YTENCiAgICAgIGFyZ3M6DQogICAgICAtIC0tcmVnaW9uDQogICAgICAtIHVzLXdlc3QtMg0KICAgICAgLSBla3MNCiAgICAgIC0gZ2V0LXRva2VuDQogICAgICAtIC0tY2x1c3Rlci1uYW1lDQogICAgICAtIGVkdWNhdGlvbi1la3MtaEdmNVV4N2ENCiAgICAgIC0gLS1vdXRwdXQNCiAgICAgIC0ganNvbg0KICAgICAgY29tbWFuZDogYXdzDQotIG5hbWU6IGFybjphd3M6ZWtzOnVzLXdlc3QtMjo3NjI0MTIwMTgxMTg6Y2x1c3Rlci9zdGFnaW5nLWRlbW8NCiAgdXNlcjoNCiAgICBleGVjOg0KICAgICAgYXBpVmVyc2lvbjogY2xpZW50LmF1dGhlbnRpY2F0aW9uLms4cy5pby92MWJldGExDQogICAgICBhcmdzOg0KICAgICAgLSAtLXJlZ2lvbg0KICAgICAgLSB1cy13ZXN0LTINCiAgICAgIC0gZWtzDQogICAgICAtIGdldC10b2tlbg0KICAgICAgLSAtLWNsdXN0ZXItbmFtZQ0KICAgICAgLSBzdGFnaW5nLWRlbW8NCiAgICAgIC0gLS1vdXRwdXQNCiAgICAgIC0ganNvbg0KICAgICAgY29tbWFuZDogYXdzDQo=

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: sample-app
    permissions:
      contents: write # Needed for pushing commits

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ secrets.GITHUB_TOKEN }} # Use GitHub Actions token

      - name: Short SHA
        run: echo "GIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Login to Harbor
        run: |
          echo "${{ secrets.HARBOR_PASSWORD }}" | \
            docker login $HARBOR_REGISTRY \
            -u "${{ secrets.HARBOR_USERNAME }}" \
            --password-stdin

      - name: Build image
        run: |
          docker build -t $HARBOR_REGISTRY/$HARBOR_PROJECT/sample-app:$GIT_SHA .

      - name: Push image
        run: |
          docker push $HARBOR_REGISTRY/$HARBOR_PROJECT/sample-app:$GIT_SHA

      - name: Update Kubernetes manifest
        run: |
          sed -i "s|{{GIT_SHA}}|$GIT_SHA|g" k8s/deployment.yaml

      - name: Commit manifest update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update image to $GIT_SHA"
          file_pattern: k8s/deployment.yaml
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubeconfig
        run: |
          printf "%s" $KUBE_CONFIG | base64 -d > ~/.kube/config
          export KUBECONFIG=./kubeconfig

      - name: Apply manifests
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml

      - name: Trigger ArgoCD sync
        run: |
          kubectl patch application sample-app -n argocd \
           --type merge -p '{"metadata":{"annotations":{"syncTimestamp":"'$(date +%s)'"}}}'
